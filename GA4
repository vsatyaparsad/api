#!/bin/bash

# Set error handling
set -e

# Function to get configuration from Snowflake using SnowSQL
get_snowflake_config() {
    # Assuming you have SnowSQL configured with credentials
    local query="SELECT json_file_path, proxy_host, proxy_port, dimensions, measures, dimension_filters, start_date, end_date, output_format FROM ga4_config_table WHERE is_active = TRUE;"
    
    # Execute query and store results in variables
    read -r json_file_path proxy_host proxy_port dimensions measures filters start_date end_date output_format <<< $(snowsql -q "$query" --output-format=tsv)
    
    # Export variables for use in other functions
    export JSON_FILE_PATH="$json_file_path"
    export PROXY_HOST="$proxy_host"
    export PROXY_PORT="$proxy_port"
    export DIMENSIONS="$dimensions"
    export MEASURES="$measures"
    export FILTERS="$filters"
    export START_DATE="$start_date"
    export END_DATE="$end_date"
    export OUTPUT_FORMAT="${output_format:-csv}"  # Default to csv if not specified
}

# Function to create GA4 API request body
create_request_body() {
    local dimensions_array=(${DIMENSIONS//,/ })
    local measures_array=(${MEASURES//,/ })
    
    # Create dimensions array
    local dimensions_json="["
    for dim in "${dimensions_array[@]}"; do
        dimensions_json="$dimensions_json{\"name\":\"$dim\"},"
    done
    dimensions_json="${dimensions_json%,}]"
    
    # Create metrics array
    local metrics_json="["
    for metric in "${measures_array[@]}"; do
        metrics_json="$metrics_json{\"name\":\"$metric\"},"
    done
    metrics_json="${metrics_json%,}]"
    
    # Create date ranges
    local date_ranges="[{\"startDate\":\"$START_DATE\",\"endDate\":\"$END_DATE\"}]"
    
    # Create base request body
    local request_body="{
    \"dateRanges\": $date_ranges,
    \"dimensions\": $dimensions_json,
    \"metrics\": $metrics_json"
    
    # Add filters only if they are properly defined
    if [ -n "$FILTERS" ] && [ "$FILTERS" != "null" ] && [ "$FILTERS" != "NULL" ]; then
        # Split filters by semicolon
        IFS=';' read -ra filter_array <<< "$FILTERS"
        
        # Only proceed if we have actual filters
        if [ ${#filter_array[@]} -gt 0 ] && [ -n "${filter_array[0]}" ]; then
            # Create filter expressions
            local filter_expressions="["
            for filter in "${filter_array[@]}"; do
                # Split each filter into dimension:operator:value
                IFS=':' read -r dimension operator value <<< "$filter"
                if [ -n "$dimension" ] && [ -n "$operator" ] && [ -n "$value" ]; then
                    filter_expressions="$filter_expressions{\"filter\":{\"fieldName\":\"$dimension\",\"stringFilter\":{\"matchType\":\"$operator\",\"value\":\"$value\"}}}"
                    filter_expressions="$filter_expressions,"
                fi
            done
            filter_expressions="${filter_expressions%,}]"
            
            # Add filter to request body if we have valid expressions
            if [ "$filter_expressions" != "[]" ]; then
                request_body="$request_body,
    \"dimensionFilter\": {\"andGroup\":{\"expressions\":$filter_expressions}}"
            fi
        fi
    fi
    
    # Close the JSON object
    request_body="$request_body
}"
    
    echo "$request_body"
}

# Function to extract GA4 data
extract_ga4_data() {
    local property_id="$GA4_PROPERTY_ID"
    local request_body="$1"
    
    # Set up proxy if configured
    local proxy_args=""
    if [ -n "$PROXY_HOST" ] && [ -n "$PROXY_PORT" ]; then
        proxy_args="--proxy http://$PROXY_HOST:$PROXY_PORT"
        echo "Using proxy: http://$PROXY_HOST:$PROXY_PORT" >&2
    fi
    
    # Get the access token using OAuth2
    local client_email=$(jq -r '.client_email' "$JSON_FILE_PATH")
    local private_key=$(jq -r '.private_key' "$JSON_FILE_PATH")
    local now=$(date +%s)
    local jwt_header='{"alg":"RS256","typ":"JWT"}'
    local jwt_claim="{\"iss\":\"$client_email\",\"scope\":\"https://www.googleapis.com/auth/analytics.readonly\",\"aud\":\"https://oauth2.googleapis.com/token\",\"exp\":$((now + 3600)),\"iat\":$now}"
    
    # Create JWT
    local jwt_header_base64=$(echo -n "$jwt_header" | base64 -w 0 | tr '+/' '-_' | tr -d '=')
    local jwt_claim_base64=$(echo -n "$jwt_claim" | base64 -w 0 | tr '+/' '-_' | tr -d '=')
    local jwt_signature=$(echo -n "$jwt_header_base64.$jwt_claim_base64" | openssl dgst -sha256 -sign <(echo -n "$private_key") -binary | base64 -w 0 | tr '+/' '-_' | tr -d '=')
    local jwt="$jwt_header_base64.$jwt_claim_base64.$jwt_signature"
    
    # Get access token
    local access_token=$(curl -s -X POST $proxy_args \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=$jwt" \
        "https://oauth2.googleapis.com/token" | jq -r '.access_token')
    
    if [ -z "$access_token" ]; then
        echo "Failed to get access token" >&2
        exit 1
    fi

    # Create a temporary file for the response
    local temp_response=$(mktemp)
    
    # Make GA4 API request and save response to temp file
    local http_code=$(curl -s -w "%{http_code}" -X POST \
        $proxy_args \
        -H "Authorization: Bearer $access_token" \
        -H "Content-Type: application/json" \
        -d "$request_body" \
        -o "$temp_response" \
        "https://analyticsdata.googleapis.com/v1beta/properties/$property_id:runReport")
    
    # Check HTTP response code
    if [ "$http_code" -eq 400 ]; then
        # For 400 errors, try to get detailed error message from response
        local error_details=""
        if jq -e 'has("error")' < "$temp_response" > /dev/null 2>&1; then
            error_details=$(jq -r '.error.message + " Details: " + (.error.details[] | tostring)' < "$temp_response" 2>/dev/null || echo "")
        fi
        echo "GA4 API Error (Bad Request): ${error_details:-No detailed error message available}" >&2
        rm -f "$temp_response"
        exit 1
    elif [ "$http_code" -ne 200 ]; then
        echo "GA4 API Error: HTTP response code $http_code" >&2
        rm -f "$temp_response"
        exit 1
    fi
    
    # Check if response contains error
    if jq -e 'has("error")' < "$temp_response" > /dev/null 2>&1; then
        local error_message=$(jq -r '.error.message' < "$temp_response")
        echo "GA4 API Error: $error_message" >&2
        rm -f "$temp_response"
        exit 1
    fi
    
    # Check if we have data
    if ! jq -e 'has("rows")' < "$temp_response" > /dev/null 2>&1 || \
       [ "$(jq '.rows | length' < "$temp_response")" -eq 0 ]; then
        echo "No data returned from GA4 API" >&2
        rm -f "$temp_response"
        exit 1
    fi
    
    # Generate output filename based on format
    local output_file="ga4_data_$(date +%Y%m%d_%H%M%S).${OUTPUT_FORMAT}"
    
    if [ "${OUTPUT_FORMAT,,}" = "json" ]; then
        # For JSON output, just move the temp file to final location
        mv "$temp_response" "$output_file"
    else
        # For CSV output, make a new request with CSV format
        http_code=$(curl -s -w "%{http_code}" -X POST \
            $proxy_args \
            -H "Authorization: Bearer $access_token" \
            -H "Content-Type: application/json" \
            -d "$request_body" \
            -o "$output_file" \
            "https://analyticsdata.googleapis.com/v1beta/properties/$property_id:runReport?alt=csv")
        
        # Clean up temp file
        rm -f "$temp_response"
        
        # Check final HTTP response code for CSV request
        if [ "$http_code" -eq 400 ]; then
            echo "GA4 API Error (Bad Request) when getting CSV. Check your request parameters." >&2
            rm -f "$output_file"
            exit 1
        elif [ "$http_code" -ne 200 ]; then
            echo "GA4 API Error when getting CSV: HTTP response code $http_code" >&2
            rm -f "$output_file"
            exit 1
        fi
    fi
    
    # Return the filename
    echo "$output_file"
}

# Main execution
main() {
    echo "Starting GA4 data extraction..." >&2
    
    # Get configuration from Snowflake
    echo "Retrieving configuration from Snowflake..." >&2
    get_snowflake_config
    
    # Create request body
    echo "Creating API request..." >&2
    request_body=$(create_request_body)
    
    # Extract data
    echo "Extracting data from GA4 (${OUTPUT_FORMAT} format)..." >&2
    output_file=$(extract_ga4_data "$request_body")
    
    echo "Data successfully extracted and saved to $output_file" >&2
}

# Execute main function
main 
